---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```
# rodm2

The goal of **rodm2** is to make it easy to use the [ODM2](https://github.com/ODM2/ODM2) data model in R, in order to promote collaboration between ecologists, hydrologists, and soil scientists. 

Organize  site, sample, and sensor data all in one place! For example:

* time series hydrologic observations from a well or stream gage
* sediment sample properties from a soil core analyzed in a lab
* categorical observations manually recorded in the field

This project is just getting started! Get in touch or open an [issue](https://github.com/khondula/rodm2/issues) if you have a use case or if you're interested in collaborating. 

## Installation

You can install this package from GitHub with:

```{r, message=FALSE, eval=FALSE}
# install.packages("devtools")
devtools::install_github("khondula/rodm2")
```

## Usage Example

Organize a dataframe of time series values into a new or existing ODM2 sqlite database:

The data to upload should have time series data for one or more variables collected at one site using the same instrument. It needs at least 2 timepoints, and a "Timestamp column" formatted as YYYY-MM-DD HH:MM:SS. For example:

```{r, echo = FALSE}
ts_data <- tibble::tibble(Timestamp = c("2018-06-27 13:45:00", "2018-06-27 13:55:00"),
                   "wd" = c(180,170),
                   "ws" = c(1, 1.5), 
                   "gustspeed" = c(2, 2.5))
knitr::kable(ts_data)
```

Load up the package and create a new ODM2 database or connection object to an existing ODM2 database.

```{r}
library(rodm2)
dblite <- create_sqlite(connect = TRUE)
```

Each column in the data to upload should contain data about one variable with the same units. Create a list that specifies for each variable the column names and units:

```{r}
vars_list <- list(
  'Wind direction' = list(column = 'wd', units = 'Degree'),
  'Wind speed' = list(column = 'ws', units = 'Meter per Second'),
  'Wind gust speed' = list(column = 'gustspeed', units = 'Meter per Second')
)
```

If there are columns in the data that correspond to censor codes or data quality codes, also supply those column names as 'qualitycodecol' and/or 'censorcodecol' in the list for each variable.

Supply database connection object, new data, method, site, variables, and sampled medium to insert time series data. 

```{r}
db_insert_results_ts(db = dblite, # database connection
                     datavalues = ts_data, # dataframe with Timestamp column
                     method = "SonicAnemometer", 
                     site_code = "Site1", 
                     variables = vars_list, 
                     sampledmedium = "Air"
                     )
```

You can also specify who collected the data with `actionby` and a specific piece of equipment used with `equip_name`. Methods, variables, and site codes not already existing in the database will be added to the appropriate tables. 

## More details 

`rodm2` is designed to work either with an existing ODM2 database on a server (e.g. PostgreSQL), or with spreadsheet files that aren't (yet!) in a relational database. This package is intended to help populate, query, and visualize data that is organized with the ODM2 structure. It should not be necessary to understand ODM2 or SQL but it may help! See [here](http://odm2.github.io/ODM2/schemas/ODM2_Current/diagrams/ODM2OverviewSimplified.html) for an overview of the data structure. 

**With a PostgreSQL database**

A script for creating a PostgreSQL database with the ODM2 schema is [here](https://github.com/ODM2/ODM2/blob/master/src/blank_schema_scripts/postgresql/ODM2_for_PostgreSQL.sql) and instructions for populating the controlled vocabularies tables using a script are [here](https://github.com/ODM2/ODM2/tree/master/src/load_cvs).

You will need to create a database connection object, eg. using `DBI::dbConnect()` and your host and log-in credentials. 

**Without an external database**

Initialize an empty sqlite database with odm2 schema in your working directory (empty except for the controlled vocabulary tables). You can view and edit this database using [DB Browser for SQLite](https://sqlitebrowser.org/) outside of R. By default, `create_sqlite()` just creates the sqlite file but `connect = TRUE` will return the connection object as well. 

```{r, eval=TRUE}
library(rodm2)
dblite <- create_sqlite(connect = TRUE)
```

Or create a connection to an existing sqlite file using `dbConnect` and the name of the file. 

```{r, eval=FALSE}
dblite <- DBI::dbConnect(RSQLite::SQLite(), "odm2.sqlite")
```

There are 132 tables in the database. The "blank" database has the Units table populated as well as all of the controlled vocabularies.

See the terms for a given controlled vocabulary:

```{r}
rodm2::get_cv_terms("methodtype")
```

Explore the database structure: 

```{r}
head(DBI::dbListTables(dblite))
DBI::dbListFields(dblite, "featureactions")
head(DBI::dbReadTable(dblite, "units"))
```

## "Describe" functions

Add information using `db_describe_%TABLE%` functions. 

```{r}
rodm2::db_describe_person(db = dblite, PersonFirstName = "Wendy",
     PersonLastName = "Wetland",
     AffiliationStartDate = "2018-01-01",
     PrimaryEmail = "wendy 'at' swamps.edu")
```

There are currently "describe" functions for:

* methods
* people
* variables
* annotations
* organizations (necessary for equipment)
* sites
* site geometries

## 'Insert' functions

Data are uploaded using "insert" functions for specific types of results, eg. `db_insert_results_ts()` for a data frame of time series results. 

* time_series: time series data collected at a site using a sensor

In progress:

* measurement: in-situ point measurement (numeric) taken at a site
* category: in-situ point measurement (text/categorical) taken at a site
* sample_measurement: ex-situ measurement (numeric) of a sample taken at a site

## Acknowledgements

This project is made possible through support from [rOpenSci](https://ropensci.org/) and [SESYNC](https://www.sesync.org/). 

Read about the details and development of ODM2 in the open access paper in Environmental Modelling & Software: 

> Horsburgh, J. S., Aufdenkampe, A. K., Mayorga, E., Lehnert, K. A., Hsu, L., Song, L., Spackman Jones, A., Damiano, S. G., Tarboton, D. G., Valentine, D., Zaslavsky, I., Whitenack, T. (2016). [Observations Data Model 2: A community information model for spatially discrete Earth observations](http://dx.doi.org/10.1016/j.envsoft.2016.01.010), Environmental Modelling & Software, 79, 55-74, http://dx.doi.org/10.1016/j.envsoft.2016.01.010

