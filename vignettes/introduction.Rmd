---
title: "Insert time series results"
author: "Kelly Hondula"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Insert time series results}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Connect

Load rodm2 and create a connection to your database. If you don't have an existing database, create an empty ODM2 sqlite database using `create_sqlite(connect = TRUE)`. 

```{r}
library(rodm2)
db <- rodm2::create_sqlite(connect = TRUE)
```

## Prepare data

This example will use a data frame of "time series result observations" with 2 observations of 3 variables. For now, this data frame must have:

* datetime must be in a column called "Timestamp" and formatted as YYYY-MM-DD HH:MM:SS
* column names but terms from the variable name controlled vocabulary. Use a tibble so that the column names can be the exact terms with spaces.

```{r}
ts_data <- tibble::tibble(Timestamp = c("2018-06-27 13:45:00", "2018-06-27 13:55:00"),
                   "wd" = c(180,170),
                   "ws" = c(1, 1.5), 
                   "gustspeed" = c(2, 2.5))
head(ts_data)
```

To see a list of any controlled vocabulary terms, use the `get_cv_terms()` function. 

```{r, }
varnames <- get_cv_terms("variablename") 
grep("Wind", varnames, value = TRUE)
```

## Variables and units

A list that matches the variables (i.e. column names) to their units id required. Make sure the units are selected from existing unit names in the units table. (A new database created with `create_sqlite()` comes populated with 1203 units that can be accessed with `get_cv_terms("units")`.) 

```{r}
vars_list <- list(
  'Wind direction' = list(column = 'wd', units = 'Degree'),
  'Wind speed' = list(column = 'ws', units = 'Meter per Second'),
  'Wind gust speed' = list(column = 'gustspeed', units = 'Meter per Second')
)
```

## Insert

The required arguments to `db_insert_results_ts()` are

* database connection
* data frame with Timestamp and [Variable Name] columns
* list of ("variables" = "units") for each variable to be uploaded
* method code
* site code
* sampled medium (from medium controlled vocabulary e.g. Air, Soil, etc.)

If the variable(s), method, or site code do not already exist in the database, they will be added. 

```{r}
db_insert_results_ts(db = db, 
                     datavalues = ts_data,
                     variables = vars_list,
                     method = "SonicAnemometer",
                     site_code = "BB2",
                     sampledmedium = "Air")

```

Optional arguments: 

* processing level (otherwise "Raw data")
* actionby - First name of person who performed the action. If they do not exist in the database already, arguments to the `db_describe_person()` function must also be supplied: PersonLastName and PrimaryEmail.  
* equipment - code of the equipment used to collect the data. If not already in database, all required arguments to `db_describe_equipment()` must be supplied (at least serial_no, model_name, vendor, owner_first). If the equipment model is new, the manufacturer must also be supplied. If the owner of the equipment is not already in the people table, owner_last and owner_email must also be supplied. 

## Get values

```{r}
DBI::dbReadTable(db, "timeseriesresultvalues")
```

