---
title: "Insert time series results"
author: "Kelly Hondula"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Insert time series results}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Load rodm2 and create an empty sqlite database. Use the `connect = TRUE` argument to return the connection object to use. For an existing database, create a connection object. 

```{r}
library(rodm2)
db <- rodm2::create_sqlite(connect = TRUE)
```

This example will use a data frame of "time series result observations" with 2 observations of 3 variables. For now, this data frame must have:

* datetime must be in a column called "Timestamp" and formatted as YYYY-MM-DD H:M:S
* column names but terms from the variable name controlled vocabulary. Use a tibble so that the column names can be the exact terms with spaces.

```{r}
tsrv <- tibble::tibble(Timestamp = c("2018-06-27 13:40:00","2018-06-27 13:55:00"),
                   "Wind direction" = c(180, 170),
                   "Wind speed" = c(1.5, 1.0), 
                   "Wind gust speed" = c(0.7, 2.5))
head(tsrv)
```

To see a list of any controlled vocabulary terms, use the `get_cv_terms()` function. 

```{r, }
get_cv_terms("aggregationstatistic")
```
The output of this function can also be stored as a vector. 

```{r, eval = FALSE}
all_vars <- get_cv_terms("variablename")
names(tsrv)[-1] %in% all_vars
```

A list that matches the variables (i.e. column names) to their units iq required. Make sure the units are selected from existing unit names in the units table. A new database created with `create_sqlite()` comes populated with 1203 units. 

```{r}
vars_list <- list("Wind direction" = "Degree",
                  "Wind speed" = "Meter per Second",
                  "Wind gust speed" = "Meter per Second")
```

The required arguments to `db_insert_results_ts()` are

* database connection
* data frame with Timestamp and [Variable Name] columns
* list of ("variables" = "units") for each variable to be uploaded
* method code
* site code
* sampled medium (from medium controlled vocabulary e.g. Air, Soil, etc.)

If the variable(s), method, or site code do not already exist in the database, they will be added. 

```{r}
db_insert_results_ts(db = db, 
                     datavalues = tsrv,
                     variables = vars_list,
                     method = "SonicAnemometer",
                     site_code = "BB2",
                     sampledmedium = "Air")

```

Optional arguments: 

* processing level (otherwise "Raw data")
* actionby - First name of person who performed the action. If they do not exist in the database already, arguments to the `db_describe_person()` function must also be supplied: PersonLastName and PrimaryEmail.  
* equipment - code of the equipment used to collect the data. If not already in database, all required arguments to `db_describe_equipment()` must be supplied (there are many). 


```{r}
DBI::dbReadTable(db, "timeseriesresultvalues")
```

