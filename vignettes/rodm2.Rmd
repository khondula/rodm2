---
title: "Insert time series results"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Insert time series results}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Connect

Load rodm2 and create a connection to your database. If you don't have an existing database, create an empty ODM2 sqlite database using `create_sqlite(connect = TRUE)`. 

```{r}
library(rodm2)
db <- rodm2::create_sqlite(connect = TRUE)
```

## Prepare data

The data to upload should have time series data for one or more variables collected at one site using the same instrument. It needs at least 2 timepoints, and a "Timestamp column" formatted as YYYY-MM-DD HH:MM:SS. For example:

```{r}
ts_data <- tibble::tibble(Timestamp = c("2018-06-27 13:45:00", "2018-06-27 13:55:00"),
                   "wd" = c(180,170),
                   "ws" = c(1, 1.5), 
                   "gustspeed" = c(2, 2.5))
head(ts_data)
```


## Variables and units

A list that matches the variables (i.e. column names) to their units id required. Make sure the units are selected from existing unit names in the units table. (A new database created with `create_sqlite()` comes populated with 1203 units that can be accessed with `get_cv_terms("units")`.) 

```{r}
vars_list <- list(
  'Wind direction' = list(column = 'wd', units = 'Degree'),
  'Wind speed' = list(column = 'ws', units = 'Meter per Second'),
  'Wind gust speed' = list(column = 'gustspeed', units = 'Meter per Second')
)
```

To see a list of any controlled vocabulary terms, use the `get_cv_terms()` function. 

```{r, }
varnames <- get_cv_terms("variablename") 
grep("Wind", varnames, value = TRUE)
```

> What about time zone?

The values in the "Timestamp" column must have time in the format YYYY-MM-DD HH:MM:SS, but they can be character data or POSIXct. If they are character data, the time zone will be your computer's local time, i.e. whatever is returned from `Sys.time()`. To specify a different time zone, such as if you are uploading data that was collected before or after daylight savings time or you are using UTC, make sure that the dates in the Timestamp column are of POSIXct format with a timezone specified. You can check the timezone of an object using the function `lubridate::tz()`. In the database, datetime values are stored in one column and timezones are stored in a separate column (as "UTC offset"). In the upload function, the UTC offset is an intger determined by using `format(as.POSIXct(x), "%z")`. 

## Insert

The required arguments to `db_insert_results_ts()` are

* database connection
* data frame with Timestamp and [Variable Name] columns
* list of ("variables" = "units") for each variable to be uploaded
* method code
* site code
* sampled medium (from medium controlled vocabulary e.g. Air, Soil, etc.)

If the variable(s), method, or site code do not already exist in the database, they will be added. 

```{r}
db_insert_results_ts(db = db, 
                     datavalues = ts_data,
                     variables = vars_list,
                     method = "SonicAnemometer",
                     site_code = "BB2",
                     sampledmedium = "Air")

```

Optional arguments: 

* processing level (otherwise "Raw data")
* actionby - First name of person who performed the action. If they do not exist in the database already, arguments to the `db_describe_person()` function must also be supplied: PersonLastName and PrimaryEmail.  
* equipment - code of the equipment used to collect the data. If not already in database, all required arguments to `db_describe_equipment()` must be supplied (at least serial_no, model_name, vendor, owner_first). If the equipment model is new, the manufacturer must also be supplied. If the owner of the equipment is not already in the people table, owner_last and owner_email must also be supplied. 

## Get values

```{r}
DBI::dbReadTable(db, "timeseriesresultvalues")
```

